<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type tail
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag kubernetes.*
  format json
  read_from_head true
</source>

<filter **>
  @type record_transformer
  <record>
    hostname ${hostname}
    service_name ${tag_parts[1]}
  </record>
</filter>

<match **>
  @type copy
  <store>
    @type mongo
    host mongodb
    port 27017
    database log_monitoring
    collection logs
    
    # Buffer configuration
    <buffer>
      flush_mode interval
      flush_interval 10s
      chunk_limit_size 1MB
      queue_limit_length 32
    </buffer>
  </store>
  
  <store>
    @type s3
    aws_key_id "#{ENV['AWS_ACCESS_KEY_ID']}"
    aws_sec_key "#{ENV['AWS_SECRET_ACCESS_KEY']}"
    s3_bucket "#{ENV['AWS_S3_BUCKET']}"
    s3_region "#{ENV['AWS_REGION']}"
    path logs/%Y/%m/%d/
    s3_object_key_format %{path}%{time_slice}_%{index}.%{file_extension}
    
    <buffer time>
      timekey 1h
      timekey_wait 10m
      timekey_use_utc true
    </buffer>
  </store>
</match>
